@page "/"
@using Magic.IndexedDb
@using Magic.IndexedDb.Testing.Helpers
@using System.Text.Json
@using Magic.IndexedDb.Testing.Models
@using TestWasm.Models
@using TestWasm.Repository
@using System.Linq;

@inject IMagicIndexedDb _MagicDb

@{
    string storageQuotaText;
    string storageUsageText;
    if (storageQuota >= 1024)
    {
        storageQuota = storageQuota / 1024.0;
        // Round the value to two decimal places
        storageQuota = Math.Round(storageQuota, 2);
        // Display the value in GB
        storageQuotaText = $"{storageQuota} GB";
    }
    else
    {
        // Display the value in MB
        storageQuotaText = $"{Math.Round(storageQuota, 2)} MB";
    }

    if (storageUsage >= 1024)
    {
        storageUsage = storageUsage / 1024.0;
        // Round the value to two decimal places
        storageUsage = Math.Round(storageUsage, 2);
        // Display the value in GB
        storageUsageText = $"{storageUsage} GB";
    }
    else
    {
        // Display the value in MB
        storageUsageText = $"{Math.Round(storageUsage, 2)} MB";
    }

    // Display the storage size on the front-end
    <p>Storage Used: @storageUsageText</p>
    <p>Storage Quota: @storageQuotaText</p>

}

<PageTitle>Example</PageTitle>

<h3>Unit Tests</h3>
@foreach (var (testName, response, countResults) in TestResults)
{
    <div>
        @if (response.Success)
        {
            <strong>✅ @testName</strong> @($" - {countResults}")
        }
        else
        {
            <strong>❌ @testName</strong> @($"- {countResults}")

            @if (!string.IsNullOrWhiteSpace(response.Message))
            {
                var messages = response.Message.Split('\n', StringSplitOptions.RemoveEmptyEntries);
                foreach (var message in messages)
                {
                    <div style="margin-left: 20px;">🔍 @message</div>
                }
            }
        }
    </div>
}

<br />
<br />

<h3>People In IndexedDb!</h3>

<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Age</th>
            <th>Not Mapped</th>
            <th>Access</th>
        </tr>
    </thead>
    <tbody>
        @foreach (Person person in allPeople.OrderBy(x => x.Name))
        {
            <tr>
                <td>@person._Id</td>
                <td>@person.Name</td>
                <td>@person._Age</td>
                <td>
                    <div style="max-width: 400px; overflow-x: auto;">
                        @person.DoNotMapTest
                    </div>
                </td>

                <td>@person.Access</td>
            </tr>
        }
    </tbody>
</table>

<br />
<br />
<h3>Complex query capabilities!</h3>
<pre>
<code>
<span style="color: #2A56C6;">await</span> manager.<span style="color: #2A56C6;">Where</span><span style="color: #A31515;">&lt;Person&gt;</span>(x =&gt; x.Name.<span style="color: #2A56C6;">StartsWith</span>(<span style="color: #A31515;">"c"</span>, <span style="color: #2A56C6;">StringComparison</span>.<span style="color: #2A56C6;">OrdinalIgnoreCase</span>)
<span style="color: #2A56C6;">||</span> x.Name.<span style="color: #2A56C6;">StartsWith</span>(<span style="color: #A31515;">"l"</span>, <span style="color: #2A56C6;">StringComparison</span>.<span style="color: #2A56C6;">OrdinalIgnoreCase</span>)
<span style="color: #2A56C6;">||</span> x.Name.<span style="color: #2A56C6;">StartsWith</span>(<span style="color: #A31515;">"j"</span>, <span style="color: #2A56C6;">StringComparison</span>.<span style="color: #2A56C6;">OrdinalIgnoreCase</span>) <span style="color: #2A56C6;">&amp;&amp;</span> x._Age <span style="color: #2A56C6;">&gt;</span> <span style="color: #2A56C6;">35</span>
        ).<span style="color: #2A56C6;">OrderBy</span>(x =&gt; x._Id).<span style="color: #2A56C6;">Skip</span>(<span style="color: #2A56C6;">1</span>).<span style="color: #2A56C6;">ToListAsync</span>();
    </code>
</pre>

@code {
    public List<(string, TestResponse, string)> TestResults = new();

    private static readonly Random _random = new Random();

    public static int GetRandomYear()
    {
        return _random.Next(1980, 2024); // Upper bound is exclusive
    }

    public static DateTime GetDateWithSameMonthDay(int year)
    {
        DateTime today = DateTime.Today;
        return new DateTime(year, today.Month, today.Day);
    }

    private void RunTest<T>(string testName,
        IEnumerable<T> indexDbResults, IEnumerable<T> correctResults) where T : class
    {
        var result = TestValidator.ValidateLists(correctResults, indexDbResults);

        string countResults = $"Results: {indexDbResults.Count()}";
        if (result.Success == false)
        {
            countResults = $"IndexDB Results: {indexDbResults.Count()} / Correct Results: {correctResults.Count()}";
        }
        TestResults.Add((testName, result, countResults));
        StateHasChanged();
    }

    private List<Person> allPeople { get; set; } = new List<Person>();
    private List<Person> allPeopleCorrect { get; set; } = new List<Person>();
    private IEnumerable<Person> WhereExample { get; set; } = Enumerable.Empty<Person>();
    private double storageQuota { get; set; }
    private double storageUsage { get; set; }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {

                // Targets the default database automatically if called without any parameters.
                IMagicQuery<Person> personQuery = await _MagicDb.Query<Person>();
                await personQuery.ClearTable();

                // Choose an assigned database to Person with strictly typed enforced connected Db's.
                IMagicQuery<Person> employeeDbQuery = await _MagicDb.Query<Person>(x => x.Databases.Client);

                // Not implemented yet
                // // // Highly not suggested, but you're allowed to target databases not assigned to the Person table
                // IMagicQuery<Person> animalDbQuery = await _MagicDb.Query<Person>(IndexDbContext.Animal);

                // // // DO NOT DO THIS! I only am allowing this for maximum flexibility but this is very dangerous.
                // IMagicQuery<Person> unassignedDbQuery = await _MagicDb.QueryOverride<Person>("DbName", "SchemaName");




                Person[] persons = new Person[] {
                        new Person { Name = "Zack", DateOfBirth = null, TestInt = 9, _Age = 45, GUIY = Guid.NewGuid(), DoNotMapTest = "I buried treasure behind my house", Access=Person.Permissions.CanRead},
                        new Person { Name = "Luna", TestInt = 9, DateOfBirth = GetDateWithSameMonthDay(GetRandomYear()), _Age = 35, GUIY = Guid.NewGuid(), DoNotMapTest = "Jerry is my husband and I had an affair with Bob.", Access = Person.Permissions.CanRead|Person.Permissions.CanWrite},
                        new Person { Name = "Jerry", TestInt = 9, DateOfBirth = GetDateWithSameMonthDay(GetRandomYear()), _Age = 35, GUIY = Guid.NewGuid(), DoNotMapTest = "My wife is amazing", Access = Person.Permissions.CanRead|Person.Permissions.CanWrite|Person.Permissions.CanCreate},
                        new Person { Name = "Jamie", TestInt = 9, DateOfBirth = GetDateWithSameMonthDay(GetRandomYear()), _Age = 35, GUIY = Guid.NewGuid(), DoNotMapTest = "My wife is amazing", Access = Person.Permissions.CanRead|Person.Permissions.CanWrite|Person.Permissions.CanCreate},
                        new Person { Name = "James", TestInt = 9, DateOfBirth = GetDateWithSameMonthDay(GetRandomYear()), _Age = 35, GUIY = Guid.NewGuid(), DoNotMapTest = "My wife is amazing", Access = Person.Permissions.CanRead|Person.Permissions.CanWrite|Person.Permissions.CanCreate},
                        new Person { Name = "Jack", TestInt = 9, DateOfBirth = GetDateWithSameMonthDay(GetRandomYear()), _Age = 35, GUIY = Guid.NewGuid(), DoNotMapTest = "My wife is amazing", Access = Person.Permissions.CanRead|Person.Permissions.CanWrite|Person.Permissions.CanCreate},
                        new Person { Name = "Jon", TestInt = 9, DateOfBirth = GetDateWithSameMonthDay(GetRandomYear()), _Age = 37, GUIY = Guid.NewGuid(), DoNotMapTest = "I black mail Luna for money because I know her secret", Access = Person.Permissions.CanRead},
                        new Person { Name = "Jack", TestInt = 9, DateOfBirth = GetDateWithSameMonthDay(GetRandomYear()), _Age = 37, GUIY = Guid.NewGuid(), DoNotMapTest = "I have a drug problem", Access = Person.Permissions.CanRead|Person.Permissions.CanWrite},
                        new Person { Name = "Cathy", TestInt = 9, DateOfBirth = GetDateWithSameMonthDay(GetRandomYear()), _Age = 22, GUIY = Guid.NewGuid(), DoNotMapTest = "I got away with reading Bobs diary.", Access = Person.Permissions.CanRead | Person.Permissions.CanWrite},
                        new Person { Name = "Bob", TestInt = 3 , DateOfBirth = GetDateWithSameMonthDay(GetRandomYear()), _Age = 69, GUIY = Guid.NewGuid(), DoNotMapTest = "I caught Cathy reading my diary, but I'm too shy to confront her.", Access = Person.Permissions.CanRead },
                        new Person { Name = "Alex", TestInt = 3 , DateOfBirth = null, _Age = 80, GUIY = Guid.NewGuid(), DoNotMapTest = "I'm naked! But nobody can know!" },
                        new Person { Name = "Zapoo", DateOfBirth = null, TestInt = 9, _Age = 45, GUIY = Guid.NewGuid(), DoNotMapTest = "I buried treasure behind my house", Access=Person.Permissions.CanRead},

                        new Person { Name = "Sarah", TestInt = -1, _Age = 30, GUIY = Guid.NewGuid(), DoNotMapTest = "I hate my job", Access=Person.Permissions.CanRead},
        new Person { Name = "Michael", TestInt = 15, _Age = 50, GUIY = Guid.NewGuid(), DoNotMapTest = "I'm hiding a big secret", Access=Person.Permissions.CanRead | Person.Permissions.CanWrite},
        new Person { Name = "Tommy", TestInt = 7, _Age = 12, GUIY = Guid.NewGuid(), DoNotMapTest = "I am just a kid" },
        new Person { Name = "Grace", TestInt = 3, _Age = 90, GUIY = Guid.NewGuid(), DoNotMapTest = "I have seen the world" },
        new Person { Name = "Xylophone", TestInt = 9, _Age = 27, GUIY = Guid.NewGuid(), DoNotMapTest = "I have the weirdest name" },
        new Person { Name = "Yasmine", TestInt = 9, _Age = 40, GUIY = Guid.NewGuid(), DoNotMapTest = null },
            // Additional test case persons to stress-test LINQ validation
    new Person { Name = "Alicia", TestInt = 42, _Age = 16, GUIY = Guid.NewGuid(), DoNotMapTest = "I just got my driver's license" },
    new Person { Name = "Ben", TestInt = 0, _Age = 25, GUIY = Guid.NewGuid(), DoNotMapTest = "I have no TestInt value" },
    new Person { Name = "Clara", TestInt = 100, _Age = 65, GUIY = Guid.NewGuid(), DoNotMapTest = "I retired last week", Access = Person.Permissions.CanRead | Person.Permissions.CanWrite },
    new Person { Name = "Danny", TestInt = 9, _Age = 40, GUIY = Guid.NewGuid(), DoNotMapTest = null }, // Null handling
    new Person { Name = "Elliot", TestInt = -20, _Age = 55, GUIY = Guid.NewGuid(), DoNotMapTest = "My test int is negative" },
    new Person { Name = "Fiona", TestInt = 11, _Age = 33, GUIY = Guid.NewGuid(), DoNotMapTest = "I like puzzles" },
    new Person { Name = "George", TestInt = 8, _Age = 72, GUIY = Guid.NewGuid(), DoNotMapTest = "I fought in a war", Access = Person.Permissions.CanRead | Person.Permissions.CanWrite | Person.Permissions.CanCreate },
    new Person { Name = "Henry", TestInt = 99, _Age = 29, GUIY = Guid.NewGuid(), DoNotMapTest = "I almost made it to 100 TestInt" },
    new Person { Name = "Isla", TestInt = 2, _Age = 18, GUIY = Guid.NewGuid(), DoNotMapTest = "I just turned into an adult" },
    new Person { Name = "Jackie", TestInt = 75, _Age = 60, GUIY = Guid.NewGuid(), DoNotMapTest = "I love cooking" },
    new Person { Name = "Kevin", TestInt = 5, _Age = 48, GUIY = Guid.NewGuid(), DoNotMapTest = "I own a small business" },
    new Person { Name = "Liam", TestInt = 9, _Age = 55, GUIY = Guid.NewGuid(), DoNotMapTest = "I just became a grandfather" },
    new Person { Name = "Mona", TestInt = 88, _Age = 35, GUIY = Guid.NewGuid(), DoNotMapTest = "I am a detective", Access = Person.Permissions.CanRead | Person.Permissions.CanWrite },
    new Person { Name = "Nathan", TestInt = 7, _Age = 27, GUIY = Guid.NewGuid(), DoNotMapTest = "I play guitar" },
    new Person { Name = "Olivia", TestInt = 13, _Age = 45, GUIY = Guid.NewGuid(), DoNotMapTest = "I run marathons" },
    new Person { Name = "Patrick", TestInt = 3, _Age = 52, GUIY = Guid.NewGuid(), DoNotMapTest = "I work in IT" },
    new Person { Name = "Quinn", TestInt = 22, _Age = 42, GUIY = Guid.NewGuid(), DoNotMapTest = "I design board games" },
    new Person { Name = "Rachel", TestInt = 77, _Age = 36, GUIY = Guid.NewGuid(), DoNotMapTest = "I am a pilot" },
    new Person { Name = "Steve", TestInt = 9, _Age = 38, GUIY = Guid.NewGuid(), DoNotMapTest = "I am an engineer" },
    new Person { Name = "Tina", TestInt = 3, _Age = 68, GUIY = Guid.NewGuid(), DoNotMapTest = "I just got my pension" },
    new Person { Name = "Uma", TestInt = 14, _Age = 39, GUIY = Guid.NewGuid(), DoNotMapTest = "I teach yoga" },
    new Person { Name = "Victor", TestInt = 6, _Age = 31, GUIY = Guid.NewGuid(), DoNotMapTest = "I am an artist" },
    new Person { Name = "Wendy", TestInt = 50, _Age = 50, GUIY = Guid.NewGuid(), DoNotMapTest = "My age matches my test int" },
    new Person { Name = "Xander", TestInt = 19, _Age = 21, GUIY = Guid.NewGuid(), DoNotMapTest = "I am a college student" },
    new Person { Name = "Yara", TestInt = 90, _Age = 32, GUIY = Guid.NewGuid(), DoNotMapTest = "I work in finance" },
    new Person { Name = "Zane", TestInt = 101, _Age = 47, DateOfBirth = new DateTime(2020, 2, 10), GUIY = Guid.NewGuid(), DoNotMapTest = "I love motorcycles" },

     };


                var count = 0;
                foreach (var p in persons)
                {
                    count += 1;
                    p._Id = count;
                    p.TestIntStable = count;
                    p.TestIntStable2 = 10;
                }



                //var storageInfo = await _MagicDb.GetStorageEstimateAsync();
                //storageQuota = storageInfo.QuotaInMegabytes;
                //storageUsage = storageInfo.UsageInMegabytes;




                // WhereExample = await (manager.Where<Person>(x => x.Name.StartsWith("c", StringComparison.OrdinalIgnoreCase)
                // || x.Name.StartsWith("l", StringComparison.OrdinalIgnoreCase)
                // || x.Name.StartsWith("j", StringComparison.OrdinalIgnoreCase) && x._Age > 35
                // || x.Name.Contains("bo", StringComparison.OrdinalIgnoreCase)
                // ).OrderBy(x => x._Id).Skip(1).AsAsyncEnumerable()).ToListAsync();

                //IMagicQuery<Person> personQuery = manager.Query<Person>();

                await personQuery.AddRangeAsync(persons);

                allPeople = await personQuery.ToListAsync();



                List<Person> people = await personQuery.ToListAsync();
                StateHasChanged();

                //await manager.ClearTableAsync<Person>();
                var db = await _MagicDb.Database(IndexDbContext.Client);
                //await db.DeleteAsync();
                await db.CloseAsync();
                bool doesExist = await db.DoesExistAsync();
                bool isOpen = await db.IsOpenAsync();
                await db.OpenAsync();
                bool isOpenNow = await db.IsOpenAsync();

                var d = new DateTime();
                var asdf = d.DayOfWeek;
                var asdf2 = d.DayOfYear;

           //      RunTest("Date Year Test", await personQuery.Where(x => x.DateOfBirth.Value.Year >= 2020).ToListAsync(),
           // allPeople.Where(x => x.DateOfBirth.HasValue && x.DateOfBirth.Value.Year == 2020));


                RunTest("Ends With Test", await personQuery.Where(x => x.Name.EndsWith("ack")).ToListAsync(),
                allPeople.Where(x => x.Name.EndsWith("ack")));

                RunTest("Ends With Negative Test", await personQuery.Where(x => !x.Name.EndsWith("ack")).ToListAsync(),
                allPeople.Where(x => !x.Name.EndsWith("ack")));

                int[] myArray = { 38, 39 };

                RunTest("Contains Test", await personQuery.Where(x => myArray.Contains(x._Age)).ToListAsync(),
                allPeople.Where(x => myArray.Contains(x._Age)));

                RunTest("Combined Query Test", await personQuery.Where(x => x.Name == "Zack" && x.TestIntStable2 == 10).ToListAsync(),
           allPeople.Where(x => x.Name == "Zack" && x.TestIntStable2 == 10));

                RunTest("Get All Test", await personQuery.ToListAsync(),
           allPeople);

                RunTest("Force Cursor Equal Test", await personQuery.Cursor(x => x.Name == "Zack").ToListAsync(),
           allPeople.Where(x => x.Name == "Zack"));

                RunTest("Not Equals Test", await personQuery.Where(x => x.Name != "Zack").ToListAsync(),
                allPeople.Where(x => x.Name != "Zack"));

                RunTest("Contains Test", await personQuery.Where(x => x.Name.Contains("zac", StringComparison.OrdinalIgnoreCase)).ToListAsync(),
                allPeople.Where(x => x.Name.Contains("zac", StringComparison.OrdinalIgnoreCase)));


                RunTest("Not Contains Test", await personQuery.Where(x => !x.Name.Contains("zac", StringComparison.OrdinalIgnoreCase)).ToListAsync(),
                allPeople.Where(x => !x.Name.Contains("zac", StringComparison.OrdinalIgnoreCase)));


                RunTest("Basic Index Equal Test", await personQuery.Where(x => x.Name == "Zack").ToListAsync(),
                allPeople.Where(x => x.Name == "Zack"));

                RunTest("Basic Cursor Equal Test", await personQuery.Where(x => x._Age == 35).ToListAsync(),
                allPeople.Where(x => x._Age == 35));

                RunTest("Greater Than Age Test", await personQuery.Where(x => x._Age > 40).ToListAsync(),
                    allPeople.Where(x => x._Age > 40));

                RunTest("Less Than or Equal Test", await personQuery.Where(x => x._Age <= 35).ToListAsync(),
                    allPeople.Where(x => x._Age <= 35));

                RunTest("Contains Test", await personQuery.Where(x => x.Name.Contains("bo", StringComparison.OrdinalIgnoreCase)).ToListAsync(),
                    allPeople.Where(x => x.Name.Contains("bo", StringComparison.OrdinalIgnoreCase)));

                RunTest("StartsWith Test", await personQuery.Where(x => x.Name.StartsWith("C", StringComparison.OrdinalIgnoreCase)).ToListAsync(),
                    allPeople.Where(x => x.Name.StartsWith("C", StringComparison.OrdinalIgnoreCase)));

                RunTest("Multiple Conditions AND", await personQuery.Where(x => x._Age > 30 && x.TestInt == 9).ToListAsync(),
                    allPeople.Where(x => x._Age > 30 && x.TestInt == 9));

                RunTest("Multiple Index Conditions OR", await personQuery.Where(x => x.Name == "Isla" || x.Name == "Zack").ToListAsync(),
                    allPeople.Where(x => x.Name == "Zack" || x.Name == "Isla"));

                RunTest("Multiple Cursor Conditions OR", await personQuery.Where(x => x._Age > 50 || x.TestInt == 3).ToListAsync(),
                    allPeople.Where(x => x._Age > 50 || x.TestInt == 3));

                RunTest("Nested AND/OR", await personQuery.Where(x => (x._Age > 35 && x.TestInt == 9) || x.Name.Contains("bo", StringComparison.OrdinalIgnoreCase)).ToListAsync(),
                    allPeople.Where(x => (x._Age > 35 && x.TestInt == 9) || x.Name.Contains("bo", StringComparison.OrdinalIgnoreCase)));

                RunTest("Ordering Test", await personQuery.OrderBy(x => x._Age).ToListAsync(),
                    allPeople.OrderBy(x => x._Age).ThenBy(x => x._Id));

                RunTest("Order Descending Test", await personQuery.OrderByDescending(x => x._Age).ToListAsync(),
                    allPeople.OrderByDescending(x => x._Age).ThenByDescending(x => x._Id));

                RunTest("Skip Test", await personQuery.OrderBy(x => x._Age).Skip(3).ToListAsync(),
                    allPeople.OrderBy(x => x._Age).ThenBy(x => x._Id).Skip(3));

                RunTest("Take Test", await personQuery.OrderBy(x => x._Age).Take(2).ToListAsync(),
                    allPeople.OrderBy(x => x._Age).ThenBy(x => x._Id).Take(2));

                RunTest("Take & With Index Test", await personQuery.Where(x => x.Name.StartsWith("J"))
                .OrderBy(x => x.Name).Take(2).ToListAsync(),
                          allPeople.Where(x => x.Name.StartsWith("J")).OrderBy(x => x.Name).ThenBy(x => x._Id).Take(2));

                RunTest("TakeLast & With Index Test", await personQuery.Where(x => x.Name.StartsWith("J"))
                .OrderBy(x => x.Name).TakeLast(2).ToListAsync(),
                          allPeople.Where(x => x.Name.StartsWith("J")).OrderBy(x => x.Name).ThenBy(x => x._Id).TakeLast(2));

                RunTest("Take Index Test", await personQuery.OrderBy(x => x.Name).Take(2).ToListAsync(),

                              /*
                                   * Take last is special operation that changes order,
                                   * but this altered version replicates the LINQ to SQL desired result
                                   */
                          allPeople.OrderBy(x => x.Name).ThenBy(x => x._Id).Take(2));

                RunTest("TakeLast Index Test", await personQuery.OrderBy(x => x.Name).TakeLast(2).ToListAsync(),

                              /*
                                   * Take last is special operation that changes order,
                                   * but this altered version replicates the LINQ to SQL desired result
                                   */
                          allPeople.OrderBy(x => x.Name).ThenBy(x => x._Id).TakeLast(2));


                var totalPersons = await personQuery.CountAsync();
                var test1 = await personQuery.FirstOrDefaultAsync();
                var test2 = await personQuery.FirstOrDefaultAsync(x => x.Name == "Victor");

                RunTest("Cursor First Or Default Test", new List<Person>() { await personQuery.OrderBy(x => x._Age).FirstOrDefaultAsync() },
                     new List<Person>() { allPeople.OrderBy(x => x._Age).ThenBy(x => x._Id).FirstOrDefault() });

                RunTest("Cursor First Or Default Where Test", new List<Person>() { await personQuery.OrderBy(x => x._Age).FirstOrDefaultAsync(x => x.Name == "Victor") },
                     new List<Person>() { allPeople.OrderBy(x => x._Age).ThenBy(x => x._Id).FirstOrDefault(x => x.Name == "Victor") });

                RunTest("Cursor Last Or Default Test", new List<Person>() { await personQuery.OrderBy(x => x._Age).LastOrDefaultAsync() },
                new List<Person>() { allPeople.OrderBy(x => x._Age).ThenBy(x => x._Id).LastOrDefault() });

                RunTest("Cursor Last Or Default Where Test", new List<Person>() { await personQuery.Where(x => x.Name == "Victor").OrderBy(x => x._Age).LastOrDefaultAsync() },
                     new List<Person>() { allPeople.Where(x => x.Name == "Victor").OrderBy(x => x._Age).ThenBy(x => x._Id).LastOrDefault() });


                RunTest("Index First Or Default Test", new List<Person>() { await personQuery.OrderBy(x => x._Id).FirstOrDefaultAsync() },
                new List<Person>() { allPeople.OrderBy(x => x._Id).ThenBy(x => x._Id).FirstOrDefault() });

                RunTest("Index First Or Default Where Test", new List<Person>() { await personQuery.OrderBy(x => x._Id).FirstOrDefaultAsync(x => x.Name == "Victor") },
                     new List<Person>() { allPeople.OrderBy(x => x._Id).ThenBy(x => x._Id).FirstOrDefault(x => x.Name == "Victor") });

                RunTest("Index Last Or Default Test", new List<Person>() { await personQuery.OrderBy(x => x._Id).LastOrDefaultAsync() },
                new List<Person>() { allPeople.OrderBy(x => x._Id).ThenBy(x => x._Id).LastOrDefault() });

                RunTest("Index Last Or Default Where Test", new List<Person>() { await personQuery.Where(x => x.Name == "Victor").OrderBy(x => x._Id).LastOrDefaultAsync() },
                     new List<Person>() { allPeople.Where(x => x.Name == "Victor").OrderBy(x => x._Id).LastOrDefault() });



                RunTest("TakeLast Cursor Test", await personQuery.OrderBy(x => x._Age).TakeLast(2).ToListAsync(),
                     allPeople.OrderBy(x => x._Age).ThenBy(x => x._Id).TakeLast(2));

                // 🛠️ Chaining Multiple Where Statements
                RunTest("Chained Where Conditions",
                    await personQuery.Where(x => x._Age > 30)
                                     .Where(x => x.TestInt == 9)
                                     .ToListAsync(),
                    allPeople.Where(x => x._Age > 30).Where(x => x.TestInt == 9));

                RunTest("Chained Where with AND/OR",
                    await personQuery.Where(x => x._Age > 30)
                                     .Where(x => x.TestInt == 9 || x.Name.StartsWith("C", StringComparison.OrdinalIgnoreCase))
                                     .ToListAsync(),
                    allPeople.Where(x => x._Age > 30).Where(x => x.TestInt == 9 || x.Name.StartsWith("C", StringComparison.OrdinalIgnoreCase)));

                // 🔄 Mixing Where, OrderBy, Skip, and Take
                RunTest("Cursor Where + OrderBy + Skip + Take",
                    await personQuery.Where(x => x._Age > 30)
                                     .OrderBy(x => x._Age)
                                     .Take(3)
                                     .Skip(2)
                                     .ToListAsync(),
                    allPeople.Where(x => x._Age > 30).OrderBy(x => x._Age).ThenBy(x => x._Id).Skip(2).Take(3));

                RunTest("Index Where + OrderBy + Skip + Take",
                await personQuery.Where(x => x.Name.StartsWith("J"))
                                 .OrderBy(x => x._Id)
                                 .Take(3)
                                 .Skip(2)
                                 .ToListAsync(),
                allPeople.Where(x => x.Name.StartsWith("J")).OrderBy(x => x._Id).ThenBy(x => x._Id).Skip(2).Take(3));

                RunTest("Index Where + OrderBy Desc + Skip + Take",
                await personQuery.Where(x => x.Name.StartsWith("J"))
                                 .OrderByDescending(x => x._Id)
                                 .Take(3)
                                 .Skip(2)
                                 .ToListAsync(),
                allPeople.Where(x => x.Name.StartsWith("J")).OrderByDescending(x => x._Id).ThenByDescending(x => x._Id).Skip(2).Take(3));

                RunTest("Where + OrderByDescending + TakeLast",
                    await personQuery.Where(x => x._Age < 60)
                                     .OrderByDescending(x => x._Age)
                                     .TakeLast(2)
                                     .ToListAsync(),
                    allPeople.Where(x => x._Age < 60).OrderByDescending(x => x._Age).ThenByDescending(x => x._Id).TakeLast(2));


                // 🧩 Complex Nested Conditions
                RunTest("Nested OR within AND",
                    await personQuery.Where(x => x._Age > 30 && (x.Name.StartsWith("J") || x.TestInt == 3))
                                     .ToListAsync(),
                    allPeople.Where(x => x._Age > 30 && (x.Name.StartsWith("J") || x.TestInt == 3)));

                RunTest("Nested AND within OR",
                    await personQuery.Where(x => (x._Age > 40 && x.TestInt == 9) || x.Name.Contains("bo", StringComparison.OrdinalIgnoreCase))
                                     .ToListAsync(),
                    allPeople.Where(x => (x._Age > 40 && x.TestInt == 9) || x.Name.Contains("bo", StringComparison.OrdinalIgnoreCase)));

                // 🚀 Edge Cases
                RunTest("No Matching Records",
                    await personQuery.Where(x => x.Name == "NonExistentPerson").ToListAsync(),
                    allPeople.Where(x => x.Name == "NonExistentPerson"));

                RunTest("Null DateOfBirth Handling",
                    await personQuery.Where(x => x.DateOfBirth == null).ToListAsync(),
                    allPeople.Where(x => x.DateOfBirth == null));

                RunTest("Null Field with OR",
                    await personQuery.Where(x => x.DateOfBirth == null || x._Age > 50).ToListAsync(),
                    allPeople.Where(x => x.DateOfBirth == null || x._Age > 50));

                // 📊 Pagination Stress Test
                RunTest("Skip and Take Across Boundaries",
                    await personQuery.OrderBy(x => x._Age)
                                     .Take(5)
                                     .Skip(3)
                                     .ToListAsync(),
                    allPeople.OrderBy(x => x._Age).ThenBy(x => x._Id).Skip(3).Take(5));

                RunTest("Large Take Last Test",
                    await personQuery.OrderByDescending(x => x._Age)
                                     .TakeLast(5)
                                     .ToListAsync(),
                    allPeople.OrderByDescending(x => x._Age).ThenByDescending(x => x._Id).TakeLast(5));


                // Return ToListAsync
                RunTest("Return ToListAsync",
                    await personQuery.ToListAsync(),
                    allPeople.ToList());

                // ✅ Universal Truth Test (Always Returns Everything)
                RunTest("Universal Truth Where Condition",
                    await personQuery.Where(x => true).ToListAsync(),
                    allPeople.Where(x => true));

                // ❌ Universal False Test (Always Returns Nothing)
                RunTest("Universal False Where Condition",
                    await personQuery.Where(x => false).ToListAsync(),
                    allPeople.Where(x => false));

                // 🤯 Negation Tests
                RunTest("Negation Test (NOT EQUAL)",
                    await personQuery.Where(x => x.Name != "Zack").ToListAsync(),
                    allPeople.Where(x => x.Name != "Zack"));

                RunTest("Negation Test (NOT Contains)",
                    await personQuery.Where(x => !x.Name.Contains("bo", StringComparison.OrdinalIgnoreCase)).ToListAsync(),
                    allPeople.Where(x => !x.Name.Contains("bo", StringComparison.OrdinalIgnoreCase)));

                RunTest("Negation Test (NOT Greater Than)",
                    await personQuery.Where(x => !(x._Age > 40)).ToListAsync(),
                    allPeople.Where(x => !(x._Age > 40)));

                RunTest("Deeply Nested OR within AND",
                    await personQuery.Where(x => (x._Age < 50 || x.Name.StartsWith("Z")) && (x.TestInt == 9 && x.DateOfBirth != null))
                                     .ToListAsync(),
                    allPeople.Where(x => (x._Age < 50 || x.Name.StartsWith("Z")) && (x.TestInt == 9 && x.DateOfBirth != null)));

                // 📌 Edge Case: Querying on a Property That Doesn't Exist in Some Objects
                // THis test worked but now I secured it via the wrapper to throw an error to prevent user error!
                RunTest("Query on Optional Property (Some Missing Values)",
                    await personQuery.Where(x => x.DoNotMapTest.Contains("diary")).ToListAsync(),
                    allPeople.Where(x => x.DoNotMapTest != null && x.DoNotMapTest.Contains("diary")));


                RunTest("Where + OrderBy + Skip + TakeLast",
                    await personQuery.Where(x => x.TestInt > 2)
                                     .OrderBy(x => x._Id)
                                     .TakeLast(2)
                                     .ToListAsync(),
                    allPeople.Where(x => x.TestInt > 2).OrderBy(x => x._Id).ThenBy(x => x._Id).TakeLast(2));

                RunTest("Paginated Index Query with AND Condition",
                await personQuery.Where(x => x.TestInt > 2 && x.TestInt == 9)
                                 .OrderBy(x => x._Id)
                                 .Take(3)
                                 .Skip(1)
                                 .ToListAsync(),
                allPeople.Where(x => x.TestInt > 2 && x.TestInt == 9).OrderBy(x => x._Id).ThenBy(x => x._Id).Skip(1).Take(3));


                // 🔄 Complex Pagination with Condition
                RunTest("Paginated Cursor Query with AND Condition",
                    await personQuery.Where(x => x._Age > 30 && x.TestInt == 9)
                                     .OrderBy(x => x._Age)
                                     .Take(3)
                                     .Skip(1)
                                     .ToListAsync(),
                    allPeople.Where(x => x._Age > 30 && x.TestInt == 9).OrderBy(x => x._Age).ThenBy(x => x._Id).Skip(1).Take(3));





                // ends with not yet supported
                // // 🔀 Complex AND/OR Mix (Nested Multiple Layers)
                // RunTest("Deeply Nested AND within OR",
                //     await personQuery.Where(x => (x._Age > 30 && (x.TestInt == 9 || x.Name.StartsWith("J"))) || (x.TestInt == 3 && x.Name.EndsWith("b", StringComparison.OrdinalIgnoreCase)))
                //                      .ToListAsync(),
                //     allPeople.Where(x => (x._Age > 30 && (x.TestInt == 9 || x.Name.StartsWith("J"))) || (x.TestInt == 3 && x.Name.EndsWith("b", StringComparison.OrdinalIgnoreCase))));


                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);
            }
        }
    }
}