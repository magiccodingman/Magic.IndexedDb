using Magic.IndexedDb;
using Magic.IndexedDb.Helpers;
using Microsoft.AspNetCore.Components.Rendering;
using Microsoft.AspNetCore.Components;

namespace E2eTestWebApp.TestPages;

[Route("/OpenTest")]
public class OpenTestPage(IMagicDbFactory magic) : TestPageBase
{
    public async Task<string> DirectOpen()
    {
        _ = await magic.OpenAsync(new DbStore()
        {
            Name = "OpenTest.DirectOpen",
            Version = 1,
            StoreSchemas = []
        });
        return "OK";
    }

    public async Task<string> RegisteredOpen1()
    {
        _ = await magic.GetRegisteredAsync("OpenTest.RegisteredOpen1");
        return "OK";
    }

    public async Task<string> RegisteredOpen2()
    {
        _ = await magic.GetRegisteredAsync("OpenTest.RegisteredOpen2");
        return "OK";
    }

    public async Task<string> Get()
    {
        _ = await magic.OpenAsync(new DbStore()
        {
            Name = "OpenTest.Get",
            Version = 1,
            StoreSchemas = []
        });
        var database = magic.Get("OpenTest.Get");
        return database.DbName;
    }

    public async Task<string> StoreSchema()
    {
        _ = await magic.OpenAsync(new DbStore()
        {
            Name = "OpenTest.StoreSchema",
            Version = 1,
            StoreSchemas =
            [
                new StoreSchema()
                {
                    Name = "S1",
                    Indexes = ["I11", "I12"],
                    PrimaryKey = "P11",
                    PrimaryKeyAuto = true,
                    UniqueIndexes = ["U11", "U12"]
                },
                new StoreSchema()
                {
                    Name = "S2",
                    Indexes = [],
                    PrimaryKey = "P21",
                    PrimaryKeyAuto = false,
                    UniqueIndexes = ["U21"]
                }
            ]
        });
        return "OK";
    }
}